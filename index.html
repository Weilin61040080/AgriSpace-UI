<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSpace - UI Fixed</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
            background: #202020;
        }

        /* é¢æ¿æ¨£å¼ */
        .panel {
            position: absolute;
            top: 20px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 5px;
            color: #2c3e50;
        }

        h3 {
            margin: 15px 0 5px 0;
            font-size: 14px;
            color: #2c3e50;
            border-left: 3px solid #27ae60;
            padding-left: 5px;
        }

        /* è¦–è¦ºå¢å¼·é–‹é—œ */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bbdefb;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2196f3;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        .input-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            align-items: center;
        }

        /* å–®ä¸€è¼¸å…¥æ¡†æ¨£å¼ */
        .coord-input {
            width: 240px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        /* åº§æ¨™åˆ—è¡¨ */
        #coord-list {
            margin-bottom: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .coord-row {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            align-items: center;
        }

        .row-num {
            font-size: 12px;
            color: #888;
            width: 20px;
            text-align: right;
            margin-right: 5px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 8px;
            font-size: 12px;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        .btn-add {
            background: #fff;
            border: 1px dashed #27ae60;
            color: #27ae60;
            width: 100%;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn-add:hover {
            background: #e8f5e9;
        }

        button.action-btn {
            padding: 8px;
            border: none;
            width: 100%;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 5px;
            font-size: 13px;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #219150;
        }

        .btn-secondary {
            background: #3498db;
            color: white;
        }

        .btn-secondary:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .data-box {
            margin-top: 15px;
            padding: 10px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 4px;
            text-align: center;
        }

        .area-text {
            color: #d35400;
            font-weight: bold;
            font-size: 18px;
        }

        /* è¦–è¦ºæ¿¾é¡ */
        .ai-enhanced-vision .leaflet-tile-pane {
            filter: contrast(1.4) brightness(1.1) saturate(1.3) !important;
        }
    </style>
</head>

<body>

    <div class="panel">
        <h2>AgriSpace</h2>

        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="visionToggle" onchange="toggleVisionEnhance()">
                <span class="slider"></span>
            </label>
            <span style="font-size:14px; font-weight:bold; color:#1565c0;">é‚Šç•Œè¦–è¦ºå¢å¼·</span>
        </div>

        <h3>ä¸­å¿ƒé»å®šä½</h3>
        <div class="input-row">
            <input type="text" id="centerInput" value="40.7831, -73.9654" class="coord-input" style="width:100%">
        </div>
        <button class="action-btn btn-primary" onclick="panToCenter()">å®šä½è‡³ä¸­å¿ƒé»</button>

        <h3>è¼¸å…¥å¤šé‚Šå½¢é ‚é»</h3>
        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">æ ¼å¼: ç·¯åº¦, ç¶“åº¦ (éœ€ç”¨é€—è™Ÿåˆ†éš”)</div>

        <div id="coord-list">
        </div>

        <button class="btn-add" onclick="addCoordRow()">+ æ–°å¢åº§æ¨™é»</button>
        <button class="action-btn btn-secondary" onclick="drawPolygonFromInputs()">ç¹ªè£½å¤šé‚Šå½¢</button>

        <div class="data-box">
            <div style="font-size:12px; color:#555;">åœˆé¸é¢ç©</div>
            <span id="areaDisplay" class="area-text">0</span> mÂ²
        </div>

        <div style="margin-top: 10px;">
            <button class="action-btn btn-danger" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰æ¨™è¨˜</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script>
        // --- 1. åˆå§‹åŒ–åœ°åœ– ---
        var map = L.map('map').setView([40.7831, -73.9654], 14);

        // --- 2. å®šç¾©åœ–å±¤ ---
        var esriSatLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19, attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: 'Â© OpenStreetMap'
        });

        // Copernicus ID (æ‚¨çš„ ID)
        var myInstanceID = "069b368e-daf8-4854-9f1b-d507bd7740ec";

        var sentinelTrueColor = L.tileLayer.wms("https://sh.dataspace.copernicus.eu/ogc/wms/" + myInstanceID, {
            layers: 'TRUE_COLOR', format: 'image/png', transparent: true, version: '1.3.0', attribution: 'Copernicus Sentinel-2'
        });

        var sentinelNDVI = L.tileLayer.wms("https://sh.dataspace.copernicus.eu/ogc/wms/" + myInstanceID, {
            layers: 'VEGETATION_INDEX', format: 'image/png', transparent: true, version: '1.3.0', attribution: 'Copernicus NDVI'
        });

        // ğŸŒŸ ä¿®æ­£é»ï¼šå°‡åœ–å±¤æ§åˆ¶å™¨ç§»åˆ° "topleft" (å·¦ä¸Šè§’) ä»¥é¿å…èˆ‡å³å´é¢æ¿é‡ç–Š
        L.control.layers(
            { "é«˜æ¸…è¡›æ˜Ÿåœ– (Esri)": esriSatLayer, "ä¸€èˆ¬åœ°åœ– (OSM)": osmLayer },
            { "å³æ™‚è¡›æ˜Ÿ (True Color)": sentinelTrueColor, "ä½œç‰©å¥åº· (NDVI)": sentinelNDVI },
            { position: 'topleft' } // <--- é€™è£¡ä¿®æ”¹ä½ç½®
        ).addTo(map);

        // --- 3. æ‰‹å‹•ç¹ªåœ–åŠŸèƒ½ (Leaflet Draw) ---
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false, circle: false, marker: false, circlemarker: false, rectangle: true,
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: { color: '#27ae60', weight: 2 }
                }
            },
            edit: { featureGroup: drawnItems },
            position: 'topleft' // ç¹ªåœ–å·¥å…·ä¹Ÿä¿æŒåœ¨å·¦å´
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            clearAll();
            var layer = e.layer;
            drawnItems.addLayer(layer);
            calculateArea(layer.toGeoJSON());
        });

        map.on(L.Draw.Event.DELETED, function () {
            document.getElementById('areaDisplay').innerText = "0";
        });

        // --- 4. åŠŸèƒ½å‡½å¼ ---

        function toggleVisionEnhance() {
            var isEnabled = document.getElementById('visionToggle').checked;
            var mapContainer = document.getElementById('map');
            if (isEnabled) {
                mapContainer.classList.add('ai-enhanced-vision');
            } else {
                mapContainer.classList.remove('ai-enhanced-vision');
            }
        }

        // é è¨­è³‡æ–™ï¼šç´ç´„ä¸­å¤®å…¬åœ’çš„å››å€‹è§’è½
        var defaultCoords = [
            "40.7681, -73.9815", // è¥¿å— (Columbus Circle)
            "40.8005, -73.9582", // è¥¿åŒ—
            "40.7968, -73.9491", // æ±åŒ—
            "40.7643, -73.9730"  // æ±å—
        ];

        window.onload = function () {
            defaultCoords.forEach(function (val) {
                addCoordRow(val);
            });
        };

        function addCoordRow(value = '') {
            var container = document.getElementById('coord-list');
            var index = container.children.length + 1;

            var div = document.createElement('div');
            div.className = 'coord-row';
            div.innerHTML = `
                <span class="row-num">${index}.</span>
                <input type="text" class="coord-input full-val" placeholder="ç·¯åº¦, ç¶“åº¦" value="${value}">
                <button class="btn-remove" onclick="removeRow(this)">X</button>
            `;
            container.appendChild(div);
            updateRowNumbers();
        }

        function removeRow(btn) {
            var row = btn.parentNode;
            row.parentNode.removeChild(row);
            updateRowNumbers();
        }

        function updateRowNumbers() {
            var rows = document.querySelectorAll('#coord-list .coord-row');
            rows.forEach((row, idx) => {
                row.querySelector('.row-num').innerText = (idx + 1) + ".";
            });
        }

        function drawPolygonFromInputs() {
            var inputs = document.querySelectorAll('.full-val');
            var points = [];

            for (var i = 0; i < inputs.length; i++) {
                var raw = inputs[i].value;
                if (!raw.trim()) continue;

                var parts = raw.split(',');

                if (parts.length !== 2) {
                    alert("ç¬¬ " + (i + 1) + " è¡Œæ ¼å¼éŒ¯èª¤ï¼éœ€æœ‰é€—è™Ÿåˆ†éš” (Lat, Lng)ã€‚");
                    return;
                }

                var lat = parseFloat(parts[0].trim());
                var lng = parseFloat(parts[1].trim());

                if (isNaN(lat) || isNaN(lng)) {
                    alert("ç¬¬ " + (i + 1) + " è¡Œçš„æ•¸å€¼æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ã€‚");
                    return;
                }
                points.push([lat, lng]);
            }

            if (points.length < 3) {
                alert("è‡³å°‘éœ€è¦è¼¸å…¥ 3 å€‹é»æ‰èƒ½ç¹ªè£½å¤šé‚Šå½¢ã€‚");
                return;
            }

            clearAll();

            var polygon = L.polygon(points, { color: "#e74c3c", weight: 2, fillOpacity: 0.2 });
            drawnItems.addLayer(polygon);

            map.fitBounds(polygon.getBounds());

            calculateArea(polygon.toGeoJSON());
        }

        function calculateArea(geojson) {
            var area = turf.area(geojson);
            document.getElementById('areaDisplay').innerText = Math.round(area * 100) / 100;
        }

        function clearAll() {
            drawnItems.clearLayers();
            document.getElementById('areaDisplay').innerText = "0";
        }

        function panToCenter() {
            var raw = document.getElementById('centerInput').value;
            var parts = raw.split(',');

            if (parts.length === 2) {
                var lat = parseFloat(parts[0].trim());
                var lng = parseFloat(parts[1].trim());
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.flyTo([lat, lng], 14);
                } else {
                    alert("ä¸­å¿ƒé»åº§æ¨™æ•¸å€¼éŒ¯èª¤");
                }
            } else {
                alert("ä¸­å¿ƒé»æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨: lat, lng");
            }
        }

    </script>
</body>

</html>